<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Postal Demo</title>
    <script type="text/javascript" src="node_modules/lodash/lodash.js"></script>
    <script type="text/javascript" src="node_modules/postal/lib/postal.js"></script>
    <script>

        SDK = {
            topics: {
                GO_TO_LOBBY: "GO_TO_LOBBY",
                BALANCE_CHANGED: "BALANCE_CHANGED",
                REQUEST_FROM_IFRAME: "REQUEST_FROM_IFRAME"
            },
            channels: {
                Inbound: "inbound",
                Outbound: "outbound"
            },
            publishMessage: function(message) {
                postal.publish({
                    channel: message.channel,
                    topic: message.topic,
                    data: message.body
                });
            },
            sendMessage: function (message, iframe) {
                iframe.postMessage({ "name": message.topic, "message": message.body }, "http://localhost:52763");
            },
            processMessage: function(event) {

                var message = event.data;
                this.SDK.publishMessage({
                    "channel": this.SDK.channels.Inbound,
                    "topic": message['name'],
                    "body": message['message']
                });
            },
            initialize: function (configuration) {

                //message: {
                //    channel: this.channels.Inbound
                //};

                window.addEventListener("message", this.processMessage, false);

            },
            onGoToLobby: function(callback) {
                postal.subscribe({
                    channel: this.channels.Inbound,
                    topic: this.topics.GO_TO_LOBBY,
                    callback: function(data) {
                        callback(data);
                    }
                });
            },
            onBalanceChanged: function (callback) {
                postal.subscribe({
                    channel: this.channels.Inbound,
                    topic: this.topics.BALANCE_CHANGED,
                    callback: callback
                });
            }
        }

        window.onload = function() {

            SDK.initialize(null);
            SDK.onGoToLobby(goToLobby);
            SDK.onBalanceChanged(updateBalance);

            function goToLobby(data) {
                alert(JSON.stringify(data));
            }

            function updateBalance() {

            }


            //    window.addEventListener("message", processMessage, false);

            //    postal.subscribe({
            //        channel: "mychannel",
            //        topic: "GET_INFORMATION_RESPONSE",
            //        callback: function(data) {
            //            getInformationResponse(data);
            //        }
            //    });

            //    postal.subscribe({
            //        channel: "mychannel",
            //        topic: "IFRAME_PUSH_INFORMATION",
            //        callback: function (data) {
            //            displayIFramePushedInfo(data);
            //        }
            //    }).constraint(function (data) {
            //        var messageText = data['message'];
            //        return messageText.toLowerCase().indexOf('desmond') === -1;
            //    });

            //};

            //function getInformationRequest() {
            //    var iframe = document.getElementById("externalWebPage").contentWindow;
            //    iframe.postMessage({ "name": "GET_INFORMATION_REQUEST", "message": "get information from iframe request message" }, "http://localhost:52763");
            //}

            //function displayIFramePushedInfo(message) {
            //    document.getElementById("anotherDiv").innerHTML =
            //        "information pushed from iframe " + JSON.stringify(message);
            //}

            //function getInformationResponse(message) {
            //    document.getElementById("mainDiv").innerHTML =
            //        "information retrieved from iframe " + JSON.stringify(message);
            //}

            //function processMessage(event) {
            //    var message = event.data;
            //    var topicName = message['name'];
            //    console.log("message from iframe", message);
            //    postal.publish({
            //        channel: "mychannel",
            //        topic: topicName,
            //        data: message
            //    });
        }

        function sendMessage() {
            var iframe = document.getElementById("externalWebPage").contentWindow;
            var message = {
                "channel": this.SDK.channels.Outbound,
                "topic": this.SDK.topics.REQUEST_FROM_IFRAME,
                "body": { "requestid": "myrequestId", "requestInfo": "my request data" }
            };

            this.SDK.sendMessage(message, iframe);
        }


    </script>
</head>
<body>
    <button id="btnSendMessage" onclick="sendMessage();">Send Message</button>
    <div id="mainDiv">main page</div>
    <div id="anotherDiv">main page</div>
    <iframe id="externalWebPage" name="externalWebPage" src="http://localhost:52763/ExternalWebSite.html"></iframe>
</body>
</html>